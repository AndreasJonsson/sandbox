<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>ExtensionManager</web>
<name>WebHome</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1284043167000</creationDate>
<date>1284748953000</date>
<contentUpdateDate>1284748953000</contentUpdateDate>
<version>1.1</version>
<title>Extension Manager</title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.0</syntaxId>
<hidden>false</hidden>
<content>{{velocity}}
{{html}}
&lt;form action="$xwiki.requestURL" enctype="multipart/form-data" method="get"&gt;
&lt;fieldset&gt;

  &lt;p&gt;
    &lt;label for="extensionname"&gt;Extension name&lt;/label&gt;
    &lt;input id="extensionname" name="extensionname" type="text" title="Extension name" #if($request.extensionname)value="${escapetool.xml($request.extensionname)}"#end /&gt;
  &lt;/p&gt;

  &lt;p&gt;
    &lt;label for="extensionversion"&gt;Extension version&lt;/label&gt;
    &lt;input id="extensionversion" name="extensionversion" type="text" title="Extension name" #if($request.extensionversion)value="${escapetool.xml($request.extensionversion)}"#end /&gt;
  &lt;/p&gt;

  &lt;span class="buttonwrapper"&gt;&lt;input type="submit" value="Resolve" name="actionresolve" class="button"/&gt;&lt;/span&gt;
  &lt;span class="buttonwrapper"&gt;&lt;input type="submit" value="Install" name="actioninstall" class="button"/&gt;&lt;/span&gt;

&lt;/fieldset&gt;
&lt;/form&gt;
{{/html}}
{{/velocity}}

{{velocity}}
#if ($request.actionresolve)
  #macro(resolveExtension $extensionname $extensionversion $extensionlevel)
    #set($extension = $services.extension.resolve($extensionname, $extensionversion))
    #set($extensionclass = "${extension.class}")
    #foreach($index in [1..$extensionlevel])*#end #if($extensionclass.endsWith('CoreExtension'))**C**#elseif($extensionclass.endsWith('LocalExtension'))**I**#else**R**#end $extension.id ($extension.version#if($extensionversion != $extension.version) was $extensionversion#end)
    #resolveExtensionDependencies($extension)
  #end
  #macro(resolveExtensionDependencies $extension $extensionlevel)
    #set($extensionlevel = $extensionlevel + 1)
    #foreach ($dependency in $extension.dependencies)
      #resolveExtension($dependency.id, $dependency.version, $extensionlevel)
    #end
    #set($extensionlevel = $extensionlevel - 1)
  #end
  #resolveExtension($request.extensionname, $request.extensionversion, 1)

  **C**: core extension
  **I**: installed extension
  **R**: remote extension
#elseif($request.actioninstall)
  #if($request.confirm)
    #set($extension = $services.extension.install($request.extensionname, $request.extensionversion))
  #else
    #macro(prepareInstall $extensionname $extensionversion $extensionsToInstall $extensionsSuggested)
      #set($extension = $services.extension.resolve($extensionname, $extensionversion))
      #set($extensionclass = "${extension.class}")
      #if(!$extensionclass.endsWith('CoreExtension') &amp;&amp; !$extensionclass.endsWith('LocalExtension'))
        #set($void = $extensionsToInstall.add($extension))
      #end
      #prepareInstallDependencies($extension, $extensionsToInstall, $extensionsSuggested)
    #end
    #macro(prepareInstallDependencies $extension $extensionsToInstall $extensionsSuggested)
      #foreach ($dependency in $extension.dependencies)
        #prepareInstall($dependency.id, $dependency.version, $extensionsToInstall, $extensionsSuggested)
      #end
    #end
    #set($extensionsToInstall = [])
    #set($extensionsSuggested = [])
    #prepareInstall($request.extensionname $request.extensionversion $extensionsToInstall $extensionsSuggested)
    #if ($extensionsToInstall.empty)
      Already installed
    #else
      The following new extensions will be installed:
      #foreach ($extension in $extensionsToInstall)
        * $extension.id ($extension.version)
      #end

      #if (!$extensionsSuggested.empty)
        Suggested:
        $extensionsSuggested
      #end

      {{html}}
      &lt;form action="$xwiki.requestURL" enctype="multipart/form-data" method="get"&gt;
        &lt;input name="extensionname" value="${escapetool.xml($request.extensionname)}" type="hidden" /&gt;
        &lt;input name="extensionversion" value="${escapetool.xml($request.extensionversion)}" type="hidden" /&gt;
        &lt;input name="actioninstall" type="hidden" /&gt;
        &lt;span class="buttonwrapper"&gt;&lt;input type="submit" value="Apply" name="confirm" class="button"/&gt;&lt;/span&gt;
      &lt;/form&gt;
      {{/html}}
    #end
  #end
#elseif($request.actionuninstall)
  #if($request.confirm)
    #set($extension = $services.extension.uninstall($request.extensionname))
  #else
    #macro(prepareUninstall $extensionname $extensionsToUninstall)
      #set($void = $extensionsToUninstall.add($extensionname))
      #set($backwardDependencies = $services.extension.getBackwardDependencies($extensionname))
      #prepareUninstallBackwardDependencies($backwardDependencies, $extensionsToUninstall)
    #end
    #macro(prepareUninstallBackwardDependencies $backwardDependencies $extensionsToUninstall)
      #foreach ($backwardDependency in $backwardDependencies)
        #prepareUninstall($backwardDependency.id, $extensionsToUninstall)
      #end
    #end
    #set($extensionsToUninstall = [])
    #prepareUninstall($request.extensionname $extensionsToUninstall)
    #if ($extensionsToUninstall.empty)
      Extension does not exists
    #else
      The following extensions will be removed:
      #foreach ($extensionname in $extensionsToUninstall)
        * $extensionname
      #end

      {{html}}
      &lt;form action="$xwiki.requestURL" enctype="multipart/form-data" method="get"&gt;
        &lt;input name="extensionname" value="${escapetool.xml($request.extensionname)}" type="hidden" /&gt;
        &lt;input name="extensionversion" value="${escapetool.xml($request.extensionversion)}" type="hidden" /&gt;
        &lt;input name="actionuninstall" type="hidden" /&gt;
        &lt;span class="buttonwrapper"&gt;&lt;input type="submit" value="Apply" name="confirm" class="button"/&gt;&lt;/span&gt;
      &lt;/form&gt;
      {{/html}}
    #end
  #end
#end
{{/velocity}}

{{velocity}}
= Installed extensions

#set($extensions = $services.extension.installedExtensions)
|=Id|=Version|=Type|=Actions
#foreach($extension in $extensions)
|$extension.id|$extension.version|$extension.type|{{html clean="false"}}
      &lt;form action="$xwiki.requestURL" enctype="multipart/form-data" method="get"&gt;
        &lt;input name="extensionname" value="${escapetool.xml($extension.id)}" type="hidden" /&gt;
        &lt;input name="extensionversion" value="${escapetool.xml($extension.version)}" type="hidden" /&gt;
        &lt;span class="buttonwrapper"&gt;&lt;input type="submit" value="Uninstall" name="actionuninstall" class="button"/&gt;&lt;/span&gt;
      &lt;/form&gt;
      {{/html}}
#end
{{/velocity}}</content></xwikidoc>
