<?xml version="1.0" encoding="UTF-8"?>
<xwikidoc>
<web>Invitation</web>
<name>InvitationGuestsActions</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent>Invitation.Invitation</parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1273964827000</creationDate>
<date>1274346338000</date>
<contentUpdateDate>1274346338000</contentUpdateDate>
<version>1.1</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.0</syntaxId>
<hidden>false</hidden>
<content>{{include document="InvitationCommon"/}}
{{velocity}}
#*
 * Invitation Application
 * Options for guests who are invited.
 *
 * Macros in this script don't rely on any variables except those which are passed to them and the following:
 *
 * $doc the com.xpn.xwiki.api.Document object representing the document containing this code.
 * $msg the internationalization message provider containing a get(String) and a get(String, List) function
 * $xcontext the com.xpn.xwiki.Context object for this request
 * $xwiki an object of the com.xpn.xwiki.api.XWiki class.
 * $escapetool an object of class org.apache.velocity.tools.generic.EscapeTool
 *
 * Macros also depend on other macros but only other macros which are contained in this script.
 *
 * This script is affected by the following documents:
 *
 * InvitationMessages stores all of the mail message objects. If this does not exist it will be created.
 *                    May be changed in the configuration.
 *
 * InvitationMailClass the class for mail message objects. May be changed in the configuration.
 *
 * InvitationConfig configuration for this code. Contains an XObject of the class defined in this document.
 *                  If it does not exist it will be created with default values.
 *
 *###
##
##---------------------------------------------------------------------
## Decide what we should do.
##---------------------------------------------------------------------
##
#set($action = [])
#getUserAction($request.getParameterMap(), $action)
#if($action.size() &gt; 0)
  #set($action = $action.get(0))
  ## Load config and mail.
  #set($config = {})
  #loadInvitationConfig($config)
  #set($mail = {})
  #loadInvitationMail($config, $mail)
  ##
  ## Load CSS
  $xwiki.get('ssx').use($config.get('mainPage'))
  ##
  ## Don't load comments, history, etc.
  #set($docextras = [])
  ##
  ## Load the document to save objects in.
  #set($emailContainer = $xwiki.getDocumentAsAuthor($config.get('emailContainer')))
  ##
  #doAction($request.getParameter('messageID'),
            $action,
            $request.getParameter('memo'),
            $request.getParameter('confirm'),
            $mail,
            $emailContainer)
#end
##
##---------------------------------------------------------------------
## The macros (Nothing below this point is run directly)
##---------------------------------------------------------------------
##
#*
 * Do a guest allowed action on a single message.
 *
 * Action codes:
 * accept (message status code must be 1)
 * decline (message status code must be 1)
 * report (as spam) (message status code must not be 6)
 * else - unknown code
 *
 * $messageID (String) the unique ID of the invitation to act upon.
 *
 * $action (String) the action to do.
 *
 * $memo (String) an action specific message to attach to the mail EG: reason for declining, 
 *                or results of spam investigation.
 *
 * $confirm (Boolean) are you sure you want to do this?
 *
 * $mail (Map&lt;String, XObject&gt;) the map of stored messages by their id.
 *
 * $emailContainer (Document) the document to save after changing objects.
 *###
#macro(doAction, $messageID, $action, $memo, $confirm, $mail, $emailContainer)
  ##
  ## 1. get message. (If it's invalid will be '' and each action handles differently.)
  #set($message = '')
  #set($message = $mail.get($messageID))
  #if($message != '')
    #set($status = $message.getProperty('statusCode').getValue())
  #end
  #set($oldMemo = "#getLastMemo($message)")

  ## 3. Do action.
  #if($action == 'accept')
    ## Accept invitation. &lt;------------------------------------------------------------------------
    #if("$!message" == '')
      {{error}}$msg.get('xe.invitation.doAction.accept.noMessageFound'){{/error}}
    #elseif($status == 'accepted')
      ## already accepted
      {{error}}$msg.get('xe.invitation.doAction.accept.alreadyAccepted'){{/error}}
    #elseif($status == 'declined')
      ## already declined
      {{error}}$msg.get('xe.invitation.doAction.accept.alreadyDeclined'){{/error}}
    #elseif($status == 'canceled')
      ## invitation canceled.
      {{error}}$msg.get('xe.invitation.doAction.accept.invitationCanceled'){{/error}}
      #if("$!oldMemo" != '')
        $msg.get('xe.invitation.doAction.invitationCanceledMemo',
                 [$xwiki.getUserName($message.getProperty('sendingUser').getValue(), false)])
        $oldMemo
      #end
    #elseif($status == '5' || $status == '6')
      ## reported as spam, nolonger valid.
      {{error}}$msg.get('xe.invitation.doAction.accept.alreadyReportedAsSpam'){{/error}}
    #elseif($status != '1')
      {{error}}$msg.get('xe.invitation.doAction.invalidStatus', ["#messageStatusForCode($status)"]){{/error}}
    #else
      #if("#canGuestAcceptInvitation($doc)" != 'true')
      ##
        {{error}}$msg.get('xe.invitation.doAction.accept.improperConfiguration'){{/error}}
      #else
        #define($doAfterRegistration)
          $message.set('statusCode', '2')##
          $emailContainer.saveAsAuthor($msg.get('xe.invitation.doAction.accept.saveComment'))
        #end
        #set($invited = true)
        {{include document="XWiki.Registration"}}
      #end
    #end
  #elseif($action == 'decline')
    ## Decline Invitation &lt;------------------------------------------------------------------------
    = $msg.get('xe.invitation.doAction.decline.heading') =
    #if("$!message" == '')
      {{error}}$msg.get('xe.invitation.doAction.decline.noMessageFound'){{/error}}
    #elseif($status == '2')
      ## already accepted
      {{error}}$msg.get('xe.invitation.doAction.decline.alreadyAccepted'){{/error}}
    #elseif($status == '3')
      ## already declined
      {{error}}$msg.get('xe.invitation.doAction.decline.alreadyDeclined'){{/error}}
    #elseif($status == '4')
      ## invitation canceled.
      {{error}}$msg.get('xe.invitation.doAction.decline.invitationCanceled'){{/error}}

       #if("$!oldMemo" != '')
         $msg.get('xe.invitation.doAction.invitationCanceledMemo', 
                  [$xwiki.getUserName($message.getProperty('sendingUser').getValue(), false)])
         $oldMemo
       #end
    #elseif($status == '5' || $status == '6')
      ## reported as spam, nolonger valid.
      {{error}}$msg.get('xe.invitation.doAction.decline.alreadyReportedAsSpam'){{/error}}
    #elseif($status != '1')
      {{error}}$msg.get('xe.invitation.doAction.invalidStatus', ["#messageStatusForCode($status)"]){{/error}}
    #elseif($confirm)
      #setMessageStatus($message, 'declined', $memo)##
      $emailContainer.saveAsAuthor($msg.get('xe.invitation.doAction.decline.saveComment'))
      {{info}}$msg.get('xe.invitation.doAction.decline.success'){{/info}}
    #else
      ## Are you sure?...
      #displayActionConfirmationForm([$messageID],
                                     $action,
                                     $msg.get('xe.invitation.doAction.decline.memoLabel', 
                                         [$xwiki.getUserName($message.getProperty('sendingUser').getValue(), false)]),
                                     $msg.get('xe.invitation.doAction.decline.confirmLabel'),
                                     {})
    #end
  #elseif($action == 'report')
    ## Report Abuse &lt;------------------------------------------------------------------------------
    = $msg.get('xe.invitation.doAction.reportSpam.heading') =
    #if("$!message" == '')
      ## No message found by that id.
      $msg.get('xe.invitation.doAction.reportSpam.noMessageFound')
    #elseif($confirm)
      #setMessageStatus($message, 'reported', $memo)##
      $emailContainer.saveAsAuthor($msg.get('xe.invitation.doAction.reportSpam.reportSaveComment'))
      ## Your report has been logged, sorry for the inconvienence.
      $msg.get('xe.invitation.doAction.reportSpam.success')
    #else
      ## Are you sure?...
      == $msg.get('xe.invitation.doAction.reportSpam.areYouSure') ==
      #displayActionConfirmationForm([$messageID],
                                     $action,
                                     $msg.get('xe.invitation.doAction.reportSpam.memoLabel'),
                                     $msg.get('xe.invitation.doAction.confirmLabel'),
                                     {})
      #displayMessage($message)
    #end
  #else
    ## Should not happen
    Invalid action
  #end
#end
{{/velocity}}</content></xwikidoc>
