<?xml version="1.0" encoding="UTF-8"?>

<xwikidoc>
<web>AnnotationCode</web>
<name>Macros</name>
<language></language>
<defaultLanguage>en</defaultLanguage>
<translation>0</translation>
<parent></parent>
<creator>XWiki.Admin</creator>
<author>XWiki.Admin</author>
<customClass></customClass>
<contentAuthor>XWiki.Admin</contentAuthor>
<creationDate>1264959390000</creationDate>
<date>1265017509000</date>
<contentUpdateDate>1265017509000</contentUpdateDate>
<version>1.0</version>
<title></title>
<template></template>
<defaultTemplate></defaultTemplate>
<validationScript></validationScript>
<comment></comment>
<minorEdit>false</minorEdit>
<syntaxId>xwiki/2.0</syntaxId>
<hidden>false</hidden>
<content>
{{velocity filter="none" output="false"}}
## Retrieve the annotation class from the configuration
#set($config = 'AnnotationCode.AnnotationConfig')
#set($annotationClassDocName = $xwiki.getDocument($config).getObject($config).getProperty('annotationClass').value)
#set($annotationClass = $xwiki.getDocument("$!{annotationClassDocName}").getxWikiClass())
##
##
## Do not display these 'internal' properties in the form:
#set($hiddenProperties = ['selection', 'selectionContext', 'originalSelection', 'target', 'date', 'author', 'state', 'color'])
##
##
#*
 * Display a box for creating an annotation
 *
 * @param $space the space of the annotated document 
 * @param $page the name of the annotated document
 * @param $annData a map containing the mandatory selection-related fields
 *#
#macro(displayCreateBox $space $page $annData)
&lt;div class="annotation-box annotation-box-create"&gt;
  &lt;form method="PUT" action="/xwiki/rest/wikis/${context.wiki}/spaces/${space}/pages/${page}/annotation"&gt;
    &lt;div class="hidden"&gt;
      #foreach($field in $annData.keySet())
         &lt;input type="hidden" name="${field}" value="$!{annData.get(${field})}"/&gt;
      #end
    &lt;/div&gt;
    #displayAnnotation($annData, 'create')
    #displayAnnotationBoxButtons('create')
  &lt;/form&gt;
&lt;/div&gt;
#end
#*
 * Display a box for editing an annotation
 *
 * @param $target the annotated entity identifier 
 * @param $id the annotation identifier
 *#
#macro(displayEditBox $target $id)
  #set($ann = $annotations.getAnnotation($target, $id))
  &lt;div class="annotation-box annotation-box-edit"&gt;
    ## TODO set the form action
    &lt;form method='' action=""&gt;
      #displayAnnotation($ann, 'edit')
      #displayAnnotationBoxButtons('edit')
    &lt;/form&gt;
  &lt;/div&gt;
#end
#*
 * Display a box containing the annotation
 *
 * @param $target the annotated entity identifier 
 * @param $id the annotation identifier
 *#
#macro(displayViewBox $target $id)
  #set($ann = $annotations.getAnnotation($target, $id))
  &lt;div class="annotation-box annotation-box-view"&gt;
    #displayAnnotation($ann $mode)
  &lt;/div&gt;
#end
##
##
##
#*
 * Display form buttons
 *
 * @param $mode 'create' or 'edit' 
 *#
#macro(displayAnnotationBoxButtons $mode)
  &lt;div class="buttons"&gt;
    &lt;span class='buttonwrapper'&gt;&lt;input type="submit" class='button' value='$msg.get("annotations.action.${mode}.submit.text")'/&gt;&lt;/span&gt;
    &lt;span class='buttonwrapper'&gt;&lt;input type="reset" class='button' value='$msg.get("annotations.action.${mode}.cancel.text")'/&gt;&lt;/span&gt;
  &lt;/div&gt;
#end
##
##
#**
 * Display an annotation
 *
 * @param $ann the annotation object
 * @param $mode view (default), list, create or edit
 *#
#macro(displayAnnotation $ann $mode)
  #if(!$listtool.contains(['view', 'list', 'create', 'edit'], "$!{mode}"))
    #set($mode = 'view')
  #end
  &lt;div class="annotation $!{ann.state}" id="annotation_${mode}_${ann.id}"&gt;
    &lt;div class="annotationHeader"&gt;
      #displayAnnotationTitle($ann)
      #displayAnnotationToolbox($ann $mode)
    &lt;/div&gt;
    &lt;div class="annotationContent"&gt;
      #displayAnnotationBody($ann $mode)
    &lt;/div&gt;
  &lt;/div&gt;
#end
##
##
#**
 * Display the annotation title, containing author and date
 *
 * @param $ann the annotation object
 *#
#macro(displayAnnotationTitle $ann)
  &lt;div&gt;
    &lt;span class="annotationAuthor"&gt;$!xwiki.getUserName($ann.author)&lt;/span&gt;##
## Do not indent this, or the comma will be misplaced
#if("$!{ann.displayDate}" != ''), &lt;span class="annotationDate"&gt;$ann.displayDate&lt;/span&gt;#end
  &lt;/div&gt;
#end
##
##
#**
 * Display the annotation toolbox:
 * - 'verify' button for modified annotations
 * - 'edit' button for annotation authors and other users with edit rights, unless already editing
 * - 'delete' button for annotation authors and other users with edit rights
 *
 * @param $ann the annotation object
 * @param $mode view (default), list, create or edit
 *#
#macro(displayAnnotationToolbox $ann $mode)
  &lt;span class="annotationTools"&gt;
    #if($mode != 'create' &amp;&amp; ($ann.author == $context.user || $hasEdit))
      #if ("$!{ann.state}" == 'UPDATED')
        ## TODO set the correct url for the 'verify' button
        &lt;span class="tool accept"&gt;&lt;a class="accept" href="#" title="$msg.get('annotations.accept.action.tooltip')"&gt;$msg.get('annotations.accept.action.text')&lt;/a&gt;&lt;/span&gt;
      #end
      #if ($mode != 'edit')
        ## TODO set the correct url for the 'edit' button
        &lt;span class="tool annotationEdit"&gt;&lt;a class="edit" href="#" title="$msg.get('annotations.edit.action.tooltip')"&gt;$msg.get('annotations.edit.action.text')&lt;/a&gt;&lt;/span&gt;
      #end
      ## TODO: fix this url to be generated less hardcoded
      #set($deleteURL = "/xwiki/rest/wikis/" + $context.database + "/spaces/" + $doc.space + "/pages/" + $doc.name + "/annotation/" + $util.encodeURI($ann.id) + "?method=DELETE")
      &lt;span class="tool delete"&gt;&lt;a class="delete" href="${deleteURL}" title="$msg.get('annotations.delete.action.tooltip')"&gt;$msg.get('annotations.delete.action.text')&lt;/a&gt;&lt;/span&gt;
    #end
  &lt;/span&gt;
#end
##
##
#**
 * Display the annotation body, containing all but the hidden fields.
 * For annotation lists (which are not displayed near the actual annotation text), also display
 * in a block quote the corresponding annotated extract.
 * Depending on the mode, display for each field label + input (edit, create) or the field value (view, list).
 *
 * @param $ann the annotation object
 * @param $mode view (default), list, create or edit
 *#
#macro(displayAnnotationBody $ann $mode)
  #if ($mode == 'list') 
    &lt;blockquote class="annotatedText"&gt;$ann.selection&lt;/blockquote&gt;
  #end
  #if($mode == 'edit' || $mode == 'create')
    #generateAnnForm($ann)
  #else
    #generateAnnContent($ann)
  #end
#end
##
##
#**
 * Generated a form which allows to edit the fields that are not hidden.
 * Used in the 'create' and 'edit' display modes.
 *
 * @param $ann the annotation object
 *#
#macro(generateAnnForm $ann)
  ## Fake object that allows to use the API to generate the form
  #set($fakeObj = $doc.newObject($annotationClassDocName))
  #set($properties = $annotationClass.properties)
  &lt;dl&gt;
  #foreach($prop in $properties)
    #if (!$listtool.contains($hiddenProperties, $prop.name))
      #set($discard = $fakeObj.set($prop.name, "$!{ann.get($prop.name)}"))
      &lt;dt class="label"&gt;&lt;label for="$prop.name"&gt;$prop.prettyName&lt;/label&gt;&lt;/dt&gt;
      &lt;dd&gt;$doc.displayEdit($prop, "" , $fakeObj)&lt;/dd&gt;
    #end
  #end
  &lt;/dl&gt;
#end
##
##
#**
 * Generates the annotation content. Should be customized to correspond to the annotation class structure.
 * Used in the 'view' and 'list' display modes.
 *
 * @param $ann the annotation object
 *#
#macro(generateAnnContent $ann)
  &lt;div class="annotationComment"&gt;$!{ann.annotation}&lt;/div&gt;
#end
{{/velocity}}</content>
</xwikidoc>
